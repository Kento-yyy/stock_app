<!DOCTYPE html> 
<html>
<head>
  <meta charset="utf-8"/>
  <title>Portfolio (DB-driven)</title>
    <style>
      /* Base typography */
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, 'Noto Sans JP', 'Apple Color Emoji',
          'Segoe UI Emoji', sans-serif;
        margin: 0;
        background: #f9fafb;
        color: #111;
      }

      h2 {
        margin: 12px 0 8px;
        font-weight: 600;
        font-size: 1.4rem;
      }

      .muted { color:#666; font-size:12px; }
      .toolbar {
        display:flex; align-items:center; gap:10px; flex-wrap:wrap;
        margin:8px 0 14px;
      }

      /* Table styling */
      .table-wrap { overflow-x:auto; margin-bottom:18px; }
      table {
        border-collapse:collapse; width:100%; max-width:100%;
        box-shadow:0 1px 3px rgba(0,0,0,.12);
        background:#fff;
      }
  th, td {
    padding:8px 10px; white-space:nowrap;
    border-bottom:1px solid #e5e7eb;
    /* Default left alignment for header and first column */
    text-align:left;
  }
  /* Right‑align all other columns (numeric data) */
  td:not(:first-child), th:not(:first-child) { text-align:right; }
      th { background:#f3f4f6; text-align:right; user-select:none; font-weight:500; }
      th:first-child, td:first-child { text-align:left; }
     tr:nth-child(even) td { background:#fafafa; }
     tr:hover td { background:#e9ecef; }
     /* Align total column to the right for consistency */
     tfoot td { font-weight:bold; background:#f3f4f6; text-align:right; }

      .chg { color:#666; font-size:12px; margin-left:4px; white-space:nowrap; }
      .chg .up { color:#0a0; }
      .chg .down { color:#c00; }
      .sortable { cursor:pointer; }
      .sort-indicator { margin-left:6px; color:#888; font-size:11px; }
  .company-name { color:#888; font-size:12px; margin-left:4px; }
  .hide { display:none; }
    </style>
<script>
(function(){
  // Currency selector state
  var currency = localStorage.getItem('currency') || 'USD';

  function setCurrency(c){
    currency = c;
    localStorage.setItem('currency', c);
    render();
    toggleVisibility();
  }
    function getApiBase(){
      try{
        var p = new URLSearchParams(location.search).get('api');
        if (p) return p.replace(/\/$/, '');
        var ls = localStorage.getItem('PF_API_BASE');
        if (ls) return ls.replace(/\/$/, '');
      }catch(e){}
      return null;
    }
    function getWorkerBase(){
      var b = getApiBase();
      if (!b) return null;
      try{
        var u = new URL(b, location.origin);
        // normalize: strip trailing /quote... or /api...
        if (/\/(quote)(\/.+)?$/i.test(u.pathname)){
          u.pathname = u.pathname.replace(/\/(quote)(\/.+)?$/i, '/');
        }
        if (/\/(api)(\/.+)?$/i.test(u.pathname)){
          u.pathname = u.pathname.replace(/\/(api)(\/.+)?$/i, '/');
        }
        return u.toString().replace(/\/$/, '');
      }catch(_){
        return b
          .replace(/\/(quote)(\/.+)?$/i, '')
          .replace(/\/(api)(\/.+)?$/i, '');
      }
    }
    function dateOnly(d){
      try{
        var dt = d ? new Date(d) : new Date();
        var pad = function(n){ return String(n).padStart(2,'0'); };
        return dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate());
      }catch(e){ return ''; }
    }
    function pct(from, to){
      var a = Number(from), b = Number(to);
      if (!Number.isFinite(a) || !Number.isFinite(b) || a <= 0) return null;
      return (b - a) / a;
    }
    function fmtUSD(n){ return (Number.isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}) : ''); }
    function fmtJPY(n){ return (Number.isFinite(n) ? Math.round(n).toLocaleString() : ''); }
    function tdPctCell(frac){
      var el = document.createElement('td');
      if (!Number.isFinite(frac)) { el.textContent=''; return el; }
      var cls = frac >= 0 ? 'up':'down';
      var v = (frac*100).toFixed(1);
      el.innerHTML = "<span class='chg'><span class='"+cls+"'>" + (frac>=0?'+':'') + v + "%</span></span>";
      el.setAttribute('data-value', String(frac));
      return el;
    }
    function isJpx(sym){ return /\.T$/i.test(String(sym||'')); }
    function parseNum(v){ var n = Number(v); return Number.isFinite(n) ? n : NaN; }

    async function fetchHoldings(){
      var base = getWorkerBase(); if (!base) throw new Error('API未指定: ?api=...');
      var r = await fetch(base + '/api/portfolio', { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      var rows = await r.json();
      if (!Array.isArray(rows)) throw new Error('invalid holdings');
      return rows;
    }
      async function fetchQuotes(){
        var base = getWorkerBase(); if (!base) throw new Error('API未指定: ?api=...');
        var r = await fetch(base + '/api/quotes_new', { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP '+r.status);
        var rows = await r.json();
        if (!Array.isArray(rows)) throw new Error('invalid quotes');
        return rows;
      }
      async function fetchUsdJpy(){
        var base = getWorkerBase(); if (!base) throw new Error('API未指定: ?api=...');
        var r = await fetch(base + '/api/usdjpy', { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP '+r.status);
        var row = await r.json();
        return row || {};
      }
    async function fetchFundamentals(){
      var base = getWorkerBase(); if (!base) throw new Error('API未指定: ?api=...');
      var r = await fetch(base + '/api/fundamentals', { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      var rows = await r.json();
      if (!Array.isArray(rows)) throw new Error('invalid fundamentals');
      var m = {};
      rows.forEach(function(x){ if (x && x.symbol) m[String(x.symbol).toUpperCase()] = x; });
      return m;
    }

      function computeFx(usdjpy){
        function N(x){ var n = Number(x); return Number.isFinite(n) ? n : NaN; }
        var now = N(usdjpy && usdjpy.price);
        var d1  = N(usdjpy && usdjpy.price_1d);
        var m1  = N(usdjpy && usdjpy.price_1m);
        var y1  = N(usdjpy && usdjpy.price_1y);
        // Fallbacks: if a baseline FX is missing, use current FX to avoid NaN
        if (!Number.isFinite(d1)) d1 = now;
        if (!Number.isFinite(m1)) m1 = now;
        if (!Number.isFinite(y1)) y1 = now;
        return { now: now, d1: d1, m1: m1, y1: y1 };
      }

    function buildMaps(holdings, quotes){
      var hmap = {};
      holdings.forEach(function(h){ if (h && h.symbol) { hmap[String(h.symbol).toUpperCase()] = h; } });
      var qmap = {};
      quotes.forEach(function(q){ if (q && q.symbol) { qmap[String(q.symbol).toUpperCase()] = q; } });
      return { hmap: hmap, qmap: qmap };
    }

    function computeRow(sym, h, q, fx, fundMap){
      var shares = parseNum(h && h.shares);
        var price = parseNum(q && q.price);
        var cur = String(q && q.currency || '').toUpperCase();
        var usdP = null, jpyP = null;
        if (Number.isFinite(price)) {
          if (cur === 'USD') {
            usdP = price;
            if (fx && Number.isFinite(fx.now)) jpyP = price * fx.now;
          } else if (cur === 'JPY') {
            jpyP = price;
            if (fx && Number.isFinite(fx.now)) usdP = price / fx.now;
          }
        }
        var p1d = parseNum(q && q.price_1d);
        var p1m = parseNum(q && q.price_1m);
        var p1y = parseNum(q && q.price_1y);
        var usd1d = null, usd1m = null, usd1y = null;
        var jpy1d = null, jpy1m = null, jpy1y = null;
        if (Number.isFinite(p1d)) {
          if (cur === 'USD') {
            if (Number.isFinite(usdP)) usd1d = pct(p1d, usdP);
            if (Number.isFinite(jpyP) && fx && Number.isFinite(fx.d1)) jpy1d = pct(p1d * fx.d1, jpyP);
          } else if (cur === 'JPY') {
            if (Number.isFinite(jpyP)) jpy1d = pct(p1d, jpyP);
            if (Number.isFinite(usdP) && fx && Number.isFinite(fx.d1)) usd1d = pct(p1d / fx.d1, usdP);
          }
        }
        if (Number.isFinite(p1m)) {
          if (cur === 'USD') {
            if (Number.isFinite(usdP)) usd1m = pct(p1m, usdP);
            if (Number.isFinite(jpyP) && fx && Number.isFinite(fx.m1)) jpy1m = pct(p1m * fx.m1, jpyP);
          } else if (cur === 'JPY') {
            if (Number.isFinite(jpyP)) jpy1m = pct(p1m, jpyP);
            if (Number.isFinite(usdP) && fx && Number.isFinite(fx.m1)) usd1m = pct(p1m / fx.m1, usdP);
          }
        }
        if (Number.isFinite(p1y)) {
          if (cur === 'USD') {
            if (Number.isFinite(usdP)) usd1y = pct(p1y, usdP);
            if (Number.isFinite(jpyP) && fx && Number.isFinite(fx.y1)) jpy1y = pct(p1y * fx.y1, jpyP);
          } else if (cur === 'JPY') {
            if (Number.isFinite(jpyP)) jpy1y = pct(p1y, jpyP);
            if (Number.isFinite(usdP) && fx && Number.isFinite(fx.y1)) usd1y = pct(p1y / fx.y1, usdP);
          }
        }

      // PER: use fundamentals if available (currency-specific)
      var per = null;
      try{
        var f = fundMap && fundMap[sym];
        if (f && Number.isFinite(Number(f.net_income_forecast)) && Number.isFinite(Number(f.shares_outstanding))){
          var so = Number(f.shares_outstanding);
          var ccy = String(f.currency || '').toUpperCase();
          if (so > 0){
            if (ccy === 'USD' && Number.isFinite(usdP)){
              var eps_usd = Number(f.net_income_forecast) / so;
              if (eps_usd > 0) per = usdP / eps_usd;
            } else if (ccy === 'JPY' && Number.isFinite(jpyP)){
              var eps_jpy = Number(f.net_income_forecast) / so;
              if (eps_jpy > 0) per = jpyP / eps_jpy;
            }
          }
        }
      }catch(e){}

      return {
        symbol: sym,
        company_name: (h && h.company_name) ? String(h.company_name) : '',
        shares: shares,
        usdPrice: usdP,
        per: Number.isFinite(per) ? per : null,
        usd1d: usd1d,
        usd1m: usd1m,
        usd1y: usd1y,
        usdValue: (Number.isFinite(usdP) && Number.isFinite(shares)) ? (usdP * shares) : NaN,
        jpyPrice: jpyP,
        jpy1d: jpy1d,
        jpy1m: jpy1m,
        jpy1y: jpy1y,
        jpyValue: (Number.isFinite(jpyP) && Number.isFinite(shares)) ? (jpyP * shares) : NaN
      };
    }

    function clearTbody(t){ if (!t) return; t.innerHTML=''; }
    function trText(text){ var td = document.createElement('td'); td.textContent = text; return td; }
    function trNumUSD(n){ var td = document.createElement('td'); td.className='usd'; td.textContent = fmtUSD(n); td.setAttribute('data-value', Number.isFinite(n)? String(n):''); return td; }
    function trNumJPY(n){ var td = document.createElement('td'); td.className='jpy'; td.textContent = fmtJPY(n); td.setAttribute('data-value', Number.isFinite(n)? String(n):''); return td; }

    function renderTable(rows, tbody, totals){
      if (!tbody) return { usd:0, jpy:0 };
      clearTbody(tbody);
      var sumUsd = 0, sumJpy = 0;
      rows.forEach(function(r){
        var tr = document.createElement('tr');
        var tdSym = document.createElement('td');
        tdSym.setAttribute('data-value', r.symbol);
        var symSpan = document.createElement('span');
        symSpan.textContent = r.symbol;
        tdSym.appendChild(symSpan);
        if (r.company_name) {
          var nameSpan = document.createElement('span');
          nameSpan.textContent = r.company_name;
          nameSpan.className = 'company-name';
          tdSym.appendChild(nameSpan);
        }
        tr.appendChild(tdSym);
        var tdShares = document.createElement('td');
        if (Number.isFinite(r.shares)) { tdShares.textContent = String(r.shares); tdShares.setAttribute('data-value', String(r.shares)); }
        else { tdShares.textContent = ''; tdShares.setAttribute('data-value',''); }
        tr.appendChild(tdShares);
        var tdPer = document.createElement('td');
        if (Number.isFinite(r.per)) { tdPer.textContent = String(r.per.toFixed(1)); tdPer.setAttribute('data-value', String(r.per)); }
        else { tdPer.textContent = ''; tdPer.setAttribute('data-value',''); }
        tr.appendChild(tdPer);
        if(currency==='USD'){
          tr.appendChild(trNumUSD(r.usdPrice));
          tr.appendChild(tdPctCell(r.usd1d));
          tr.appendChild(tdPctCell(r.usd1m));
          tr.appendChild(tdPctCell(r.usd1y));
          tr.appendChild(trNumUSD(r.usdValue));
        } else {
          tr.appendChild(trNumJPY(r.jpyPrice));
          tr.appendChild(tdPctCell(r.jpy1d));
          tr.appendChild(tdPctCell(r.jpy1m));
          tr.appendChild(tdPctCell(r.jpy1y));
          tr.appendChild(trNumJPY(r.jpyValue));
        }
        tbody.appendChild(tr);
        if (Number.isFinite(r.usdValue)) sumUsd += r.usdValue;
        if (Number.isFinite(r.jpyValue)) sumJpy += r.jpyValue;
      });
      if (totals && totals.usdEl) totals.usdEl.textContent = fmtUSD(sumUsd);
      if (totals && totals.jpyEl) totals.jpyEl.textContent = fmtJPY(sumJpy);
      return { usd: sumUsd, jpy: sumJpy };
    }

    // ---- Sorting ----
    function getCellValue(cell, type){
      if (!cell) return (type==='num'? NaN : '');
      var dv = cell.getAttribute('data-value');
      if (type === 'num'){
        var v = (dv != null ? dv : (cell.textContent||'').replace(/[,%\s]/g,''));
        var n = parseFloat(v);
        return (Number.isFinite(n) ? n : NaN);
      } else {
        return (dv != null ? dv : (cell.textContent||'')).trim().toUpperCase();
      }
    }
    function sortTableEl(table, colIndex, asc){
      if (!table) return;
      var tbody = table.tBodies && table.tBodies[0]; if(!tbody) return;
      var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
      if (!rows.length) return;
      var ths = table.tHead && table.tHead.rows.length ? table.tHead.rows[0].cells : null;
      var type = (ths && ths[colIndex] && ths[colIndex].getAttribute('data-sort')) || (colIndex === 0 ? 'str' : 'num');
      rows.sort(function(a,b){
        var av = getCellValue(a.cells[colIndex], type);
        var bv = getCellValue(b.cells[colIndex], type);
        if (type === 'num'){
          var aNaN = !(isFinite(av));
          var bNaN = !(isFinite(bv));
          if (aNaN && bNaN) return 0;
          if (aNaN) return 1; // NaN to bottom
          if (bNaN) return -1;
          return asc ? (av - bv) : (bv - av);
        } else {
          return asc ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
        }
      });
      rows.forEach(function(r){ tbody.appendChild(r); });
      // update indicators
      if (ths && ths.length){
        for (var i=0;i<ths.length;i++){
          ths[i].removeAttribute('data-asc');
          var sp = ths[i].querySelector('.sort-indicator');
          if (!sp) { sp = document.createElement('span'); sp.className='sort-indicator'; ths[i].appendChild(sp); }
          sp.textContent = '';
        }
        var active = ths[colIndex].querySelector('.sort-indicator');
        if (active) active.textContent = asc ? '▲' : '▼';
        ths[colIndex].setAttribute('data-asc', asc ? 'true':'false');
      }
      table.dataset.sortCol = String(colIndex);
      table.dataset.sortAsc = asc ? '1' : '0';
    }
    function attachSortHandlers(table){
      if (!table) return;
      var thead = table.tHead; if(!thead || !thead.rows.length) return;
      var ths = thead.rows[0].cells;
      for (var i=0;i<ths.length;i++){
        var th = ths[i];
        th.classList.add('sortable');
        th.setAttribute('data-sort', i===0 ? 'str' : 'num');
      }
      thead.addEventListener('click', function(ev){
        var th = ev.target && ev.target.closest ? ev.target.closest('th') : null;
        if (!th || !thead.contains(th)) return;
        var idx = Array.prototype.indexOf.call(ths, th);
        if (idx == null || idx < 0) return;
        var asc = th.getAttribute('data-asc') !== 'true';
        sortTableEl(table, idx, asc);
      });
    }
    function applySavedSort(table){
      try{
        var col = table && table.dataset && table.dataset.sortCol;
        if (col == null) return;
        var asc = (table.dataset.sortAsc === '1');
        sortTableEl(table, parseInt(col,10), asc);
      }catch(e){}
    }

    async function fetchAndRender(){
      var holdings = await fetchHoldings();
      var quotes = await fetchQuotes();
      var usdjpy = await fetchUsdJpy();
      // Build maps and fx
      var maps = buildMaps(holdings, quotes);
      var qmap = maps.qmap, hmap = maps.hmap;
      var fx = computeFx(usdjpy);
      var fundMap = await fetchFundamentals().catch(function(){ return {}; });
      // Build computed rows for JP and US
      var syms = Object.keys(hmap).filter(function(s){ return s !== 'USDJPY=X'; }).sort();
      var jpRows = [], usRows = [];
      syms.forEach(function(s){
        var h = hmap[s]; var q = qmap[s] || null;
        var r = computeRow(s, h, q, fx, fundMap);
        if (isJpx(s)) jpRows.push(r); else usRows.push(r);
      });
      // Render tables
      var jpTbody = document.querySelector('#pf-jp tbody');
      var usTbody = document.querySelector('#pf-us tbody');
      var jpUsdTot = document.querySelector('#pf-jp tfoot td[data-key="USD_VALUE"]');
      var jpJpyTot = document.querySelector('#pf-jp tfoot td[data-key="JPY_VALUE"]');
      var usUsdTot = document.querySelector('#pf-us tfoot td[data-key="USD_VALUE"]');
      var usJpyTot = document.querySelector('#pf-us tfoot td[data-key="JPY_VALUE"]');
      var r1 = renderTable(jpRows, jpTbody, { usdEl: jpUsdTot, jpyEl: jpJpyTot });
      var r2 = renderTable(usRows, usTbody, { usdEl: usUsdTot, jpyEl: usJpyTot });
      // Re-apply saved sorts
      applySavedSort(document.getElementById('pf-jp'));
      applySavedSort(document.getElementById('pf-us'));
      // Overall totals
      var oUsd = (Number.isFinite(r1.usd)? r1.usd:0) + (Number.isFinite(r2.usd)? r2.usd:0);
      var oJpy = (Number.isFinite(r1.jpy)? r1.jpy:0) + (Number.isFinite(r2.jpy)? r2.jpy:0);
      var oUsdEl = document.querySelector('#pf-total tfoot td[data-key="USD_VALUE"]');
      var oJpyEl = document.querySelector('#pf-total tfoot td[data-key="JPY_VALUE"]');
      if (oUsdEl) oUsdEl.textContent = fmtUSD(oUsd);
      if (oJpyEl) oJpyEl.textContent = fmtJPY(oJpy);
      // Baseline timestamps for each period
      var bFields = ['updated_1d_at','updated_1m_at','updated_1y_at'];
      var bTimes = {};
      for (var i=0; i<bFields.length; i++) bTimes[bFields[i]] = null;
      for (var i=0; i<quotes.length; i++){
        var q = quotes[i];
        if (!q) continue;
        for (var j=0; j<bFields.length; j++){
          var f = bFields[j];
          var t = q[f];
          if (!t) continue;
          var ts = Date.parse(t);
          if (Number.isFinite(ts) && (bTimes[f] == null || ts < bTimes[f])) bTimes[f] = ts;
        }
      }
      var bEl = document.getElementById('pf-baseline-lastup');
      if (bEl){
        var parts = [];
        for (var i=0; i<bFields.length; i++){
          var f = bFields[i];
          var ts = bTimes[f];
          if (ts != null){
            var label = f.replace('updated_','').replace('_at','');
            parts.push(label + ': ' + dateOnly(ts));
          }
        }
        bEl.textContent = '基準値更新: ' + parts.join(', ');
      }
      // Timestamp
      var last = document.getElementById('pf-lastup'); if(last) last.textContent = '最終更新: ' + dateOnly();
    }

    async function maybeRefreshBaselines(){
      try{
        var base = getWorkerBase();
        if (!base) return;
        var need = false;
        try{
          var r = await fetch(base + '/api/quotes_new');
          if (r && r.ok){
            var arr = await r.json();
            var now = Date.now();
            var fields = ['updated_1d_at','updated_1m_at','updated_3m_at','updated_6m_at','updated_1y_at','updated_3y_at'];
            outer: for (var i=0; i<arr.length; i++){
              var q = arr[i];
              for (var j=0; j<fields.length; j++){
                var t = q[fields[j]];
                if (!t || (now - Date.parse(t)) >= 86400000){ need = true; break outer; }
              }
            }
          } else {
            need = true;
          }
        }catch(e){ need = true; }
        if (need){
          try{ await fetch(base + '/api/quotes_new/refresh-baselines', { method: 'POST' }); }catch(e){}
        }
      }catch(_){ }
    }
    async function maybeRefreshCurrent(){
      try{
        var base = getWorkerBase();
        if (!base) return;
        var need = false;
        try{
          var r = await fetch(base + '/api/quotes_new');
          if (r && r.ok){
            var arr = await r.json();
            var now = Date.now();
            outer: for (var i=0; i<arr.length; i++){
              var q = arr[i];
              var t = q.updated_at;
              if (!t || (now - Date.parse(t)) >= 60000){ need = true; break outer; }
              var t1d = q.updated_1d_at;
              if (!t1d || (now - Date.parse(t1d)) >= 86400000){ need = true; break outer; }
            }
          } else {
            need = true;
          }
        }catch(e){ need = true; }
        if (need){
          try{ await fetch(base + '/api/quotes_new/refresh-current', { method: 'POST' }); }catch(e){}
        }
      }catch(_){ }
    }
    async function refresh(){
      var btn = document.getElementById('pf-refresh'); if(btn){ btn.disabled=true; btn.textContent='更新中…'; }
      try{
        await maybeRefreshBaselines();
        await maybeRefreshCurrent();
        await fetchAndRender();
      }catch(e){
        var last2 = document.getElementById('pf-lastup'); if(last2) last2.textContent = '更新失敗: ' + e;
      } finally {
        if(btn){ btn.disabled=false; btn.textContent='更新'; }
      }
    }
    async function initialLoad(){
      try{
        await fetchAndRender();
      }catch(e){
        var last2 = document.getElementById('pf-lastup'); if(last2) last2.textContent = '更新失敗: ' + e;
      }
    }
    function ready(){
      // wire sorting
      attachSortHandlers(document.getElementById('pf-jp'));
      attachSortHandlers(document.getElementById('pf-us'));
    var btn = document.getElementById('pf-refresh'); if(btn) btn.addEventListener('click', refresh);
    // Currency selector UI
    var sel = document.createElement('select');
    ['USD','JPY'].forEach(function(c){
      var opt = document.createElement('option');
      opt.value=c; opt.textContent=c;
      if(currency===c) opt.selected=true;
      sel.appendChild(opt);
    });
    sel.addEventListener('change', function(){ setCurrency(this.value); });
    var toolbar = document.querySelector('.toolbar');
    toolbar.appendChild(sel);

    // Visibility helper based on selected currency
    function toggleVisibility(){
      // Column indices (1‑based): USD_PRICE=4, USD_VALUE=8, JPY_PRICE=9, JPY_VALUE=13
      const hideUsd = currency !== 'USD';
      const hideJpy = !hideUsd;

      ['#pf-jp', '#pf-us'].forEach(tbl=>{
        // data cells
        [4,8].forEach(idx=>{ // USD columns
          document.querySelectorAll(`${tbl} tr td:nth-child(${idx})`).forEach(el=>el.classList.toggle('hide', hideUsd));
        });
        [9,13].forEach(idx=>{ // JPY columns
          document.querySelectorAll(`${tbl} tr td:nth-child(${idx})`).forEach(el=>el.classList.toggle('hide', hideJpy));
        });
        // header cells
        [4,8].forEach(idx=>{
          document.querySelectorAll(`${tbl} th:nth-child(${idx})`).forEach(th=>th.classList.toggle('hide', hideUsd));
        });
        [9,13].forEach(idx=>{
          document.querySelectorAll(`${tbl} th:nth-child(${idx})`).forEach(th=>th.classList.toggle('hide', hideJpy));
        });
      });
    }
    // initial visibility
    toggleVisibility();
      initialLoad().then(refresh);
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ready); else ready();
  })();
  </script>
</head>
<body>
  <h2>ポートフォリオ（DB直接：holdings × quotes_new）</h2>
  <div class="toolbar">
    <button id="pf-refresh">更新</button>
    <span class="muted" id="pf-lastup"></span>
  </div>

  <h3>国内株</h3>
  <div class="table-wrap">
    <table id="pf-jp">
      <colgroup>
        <col style="width:22%"/>
        <col style="width:6%"/>
        <col style="width:6%"/>
        <col style="width:8%"/>
        <col style="width:5%"/>
        <col style="width:5%"/>
        <col style="width:5%"/>
        <col style="width:10%"/>
        <col style="width:8%"/>
        <col style="width:5%"/>
        <col style="width:5%"/>
        <col style="width:5%"/>
        <col style="width:10%"/>
      </colgroup>
      <thead>
        <tr>
          <th style="text-align:left">SYMBOL</th>
          <th>SHARES</th>
          <th>PER</th>
          <th>USD_PRICE</th>
          <th>1D</th>
          <th>1M</th>
          <th>1Y</th>
          <th>USD_VALUE</th>
          <th>JPY_PRICE</th>
          <th>1D</th>
          <th>1M</th>
          <th>1Y</th>
          <th>JPY_VALUE</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td style="text-align:left">TOTAL</td>
          <td></td><td></td><td></td><td></td><td></td><td></td>
          <!-- USD total with a boxed div -->
          <td data-key="USD_VALUE"><div style="border:1px solid #ccc;padding:2px 4px;border-radius:3px;"></div></td>
          <td></td><td></td><td></td><td></td>
          <!-- JPY total with a boxed div -->
          <td data-key="JPY_VALUE"><div style="border:1px solid #ccc;padding:2px 4px;border-radius:3px;"></div></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <h3>米国株</h3>
  <div class="table-wrap">
    <table id="pf-us">
      <colgroup>
        <col style="width:22%"/>
        <col style="width:6%"/>
        <col style="width:6%"/>
        <col style="width:8%"/>
        <col style="width:5%"/>
        <col style="width:5%"/>
        <col style="width:5%"/>
        <col style="width:10%"/>
        <col style="width:8%"/>
        <col style="width:5%"/>
        <col style="width:5%"/>
        <col style="width:5%"/>
        <col style="width:10%"/>
      </colgroup>
      <thead>
        <tr>
          <th style="text-align:left">SYMBOL</th>
          <th>SHARES</th>
          <th>PER</th>
          <th>USD_PRICE</th>
          <th>1D</th>
          <th>1M</th>
          <th>1Y</th>
          <th>USD_VALUE</th>
          <th>JPY_PRICE</th>
          <th>1D</th>
          <th>1M</th>
          <th>1Y</th>
          <th>JPY_VALUE</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td style="text-align:left">TOTAL</td>
          <td></td><td></td><td></td><td></td><td></td><td></td>
          <!-- USD total with boxed div -->
          <td data-key="USD_VALUE"><div style="border:1px solid #ccc;padding:2px 4px;border-radius:3px;"></div></td>
          <td></td><td></td><td></td><td></td>
          <!-- JPY total with boxed div -->
          <td data-key="JPY_VALUE"><div style="border:1px solid #ccc;padding:2px 4px;border-radius:3px;"></div></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <h3>全体合計</h3>
  <div class="table-wrap">
    <table id="pf-total">
      <colgroup>
        <col style="width:30%"/>
        <col style="width:35%"/>
        <col style="width:35%"/>
      </colgroup>
      <thead>
        <tr>
          <th style="text-align:left">TYPE</th>
          <th>USD_VALUE</th>
          <th>JPY_VALUE</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td style="text-align:left">OVERALL TOTAL</td>
          <td data-key="USD_VALUE"></td>
          <td data-key="JPY_VALUE"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <p class="muted" id="pf-baseline-lastup"></p>
  <p class="muted">注: URLに ?api=https://xxx.workers.dev/quote を付けて開くとDBから読み込みます。</p>
</body>
</html>
